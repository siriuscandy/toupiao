define(["jquery","knockout","text!pages/shopedit/edit/add.html","dialogmin","uploader","ueditor","ZeroClipboard","webuploaderdemo"],function($,ko,template,dialogmin,WebUploader,UE,ZeroClipboard){window.ZeroClipboard=ZeroClipboard;var saveUrl="/store/save";var getdataUrl="/store/getOne";var preUrl="/shopedit/detail/add";var resaveUrl="/market/store/preview";var postData="/store/fill";addRouter(preUrl);var viewModel={data:ko.observable({}),codedata:ko.observable(),appdata:ko.observable(),detailimg:"",detailimgNew:"",qualification:"",clientCase:"",sell_time:"",snapshot:ko.observable({}),ApplyTypedata:ko.observable()};viewModel.load=function(){$.ajax({type:"get",url:$ctx+getdataUrl,data:"",cache:false,dataType:"json",success:function(res){if(res.status==1){viewModel.data(res.data);viewModel.Ueditor(res.data.introduction);if(res.data.logo!=""&&res.data.logo!=null){$(".img-responsiveLOGO").attr("src",res.data.logo)}if(res.data.logo!=""&&res.data.logo!=null){$(".img-responsiveBANNER").attr("src",res.data.banner)}$(".tenant_name.onlineTime").val(res.data.onlineTime);viewModel.ImagesUp("#uploader","#filePicker","#filePicker2",res.data);if(res.data.customerService!=null){var arr=JSON.parse(res.data.customerService);var html="";for(var o in arr){if(arr[o].thisValue!=""){$(".first").remove();html+='<div class="addbox" style="display:none;"><div class="tel rowm clear" style="width:100%;"><span class="m_left left_box_width">在线客服 <em name="NO"></em> </span><div class="userAddInput onlinekf" style="width:66%;"><input type=text class="tenant_name yx_value" data-bind="value: data().onlineCustom" placeholder="有信ID" style="width:70%;" value="'+arr[o].thisValue+'"><i class="icon cl minusBtn cl-reduce-c-o" style="font-size:24px;width:25px;height:25px;"></i></div></div></div>'}else{}}$(".seizes").before(html);var addboxNum=$(".addbox").length;$(".userAddtext>.addbox:last>.tel>.userAddInput>i.icon").removeClass("minusBtn cl-reduce-c-o").addClass("addBtn cl-add-c-o")}}else{dialogmin("网络错误!!")}}});$(function(){$("body").unbind("click").delegate("i.addBtn","click",function(flag){if(flag=true){$(this).removeClass("addBtn cl-add-c-o").addClass("minusBtn cl-reduce-c-o");html='<div class="addbox" style="display:none;"><div class="tel rowm" style="width:100%;"><span class="m_left left_box_width">在线客服 <em name="NO"></em></span><div class="userAddInput onlinekf" style="width:66%;"><input type=text class="tenant_name yx_value" placeholder="有信ID" style="width:70%;"><i class="icon cl cl-add-c-o addBtn" style="font-size:24px;width:25px;height:25px;"></i></div></div>';$(".seizes").before(html);return false}});function changeIndex(){var i=1;$(".addbox .m_left").each(function(){$(this).find("em[name='NO']").val(i++)})}$("body").delegate("i.minusBtn","click",function(){$(this).parents(".addbox").remove()})});setTimeout(function(){var boxWidth=$(".shop_banner").width();var areaNum=parseInt("280")/parseInt("860");var widthImg=$(".shop_banner img").width();var heightImg=$(".shop_banner img").height();var imgAreaNum=parseInt(heightImg/widthImg);var boxHeight=boxWidth*areaNum;$(".shop_banner").height(boxHeight);if(heightImg>boxHeight){$(".tooHeight").show()}else{$(".shop_banner").css({"line-height":boxHeight+"px"});$(".tooHeight").hide()}$(".shop_banner img").css("visibility","visible")},500);if(viewModel.data().email==""){$(".editBtn .btn_c").hide()}else{$(".editBtn .btn_c").show()}$(".userAddInput .onlineTime").val("9:00-17:00")};viewModel.alertBosShow=function(){function centerH(box){box.css({left:($(window).width()-box.outerWidth())/2,top:"60px"})}var maskHeight=$("body").outerHeight()>$(window).height()?$("body").outerHeight():$(window).height();$(".section-alert-box").show();$(".section-alert-bg").height(maskHeight+50);centerH($(".boxbg"));$(".boxbg").addClass("a_show");$(".boxbg").height($(window).height()-160)};viewModel.closeBox=function(){$(".section-alert-box").hide();viewModel.detailimg=""};viewModel.stopEvent=function(){function getEvent(){if(window.event){return window.event}func=getEvent.caller;while(func!=null){var arg0=func.arguments[0];if(arg0){if((arg0.constructor==Event||arg0.constructor==MouseEvent||arg0.constructor==KeyboardEvent)||(typeof(arg0)=="object"&&arg0.preventDefault&&arg0.stopPropagation)){return arg0}}func=func.caller}return null}var e=getEvent();if(window.event){e.cancelBubble=true}else{if(e.preventDefault){e.stopPropagation()}}};viewModel.golook=function(){viewModel.verification("look")};viewModel.goback=function(){window.router.setRoute(preUrl);return false};viewModel.submitMo=function(){viewModel.verification("save")};viewModel.verification=function(n){$("#uploader .filelist .imgWrap").each(function(e){var _this=$(this);var s=_this.find("img").attr("src");if(s.indexOf("https://")>-1){if(viewModel.detailimg!=""){viewModel.detailimg+=","+s}else{viewModel.detailimg+=s}}});var links=[];var leftmenu=null;var onlineNum=$(".addbox").length;for(i=0;i<onlineNum;i++){var thisValue=$(".addbox:eq("+i+") .yx_value").val();var telIndex=$(".addbox:eq("+i+") .telbox .tel_num");
var telNum=telIndex.length;leftmenu={customId:"id"+i,thisValue:thisValue,onlineMenu:new Array()};if(leftmenu){var onlineMenu={};for(j=0;j<telNum;j++){var telValue=$(".addbox:eq("+i+") .telbox .tel_num:eq("+j+") .tel_value").val();rightMenu={telId:"id"+j,telvalue:telValue};leftmenu.onlineMenu.push(rightMenu)}links.push(leftmenu)}}var telArr=JSON.stringify(links);var enddetailImg="";if(viewModel.detailimg!=""||viewModel.detailimgNew!=""){enddetailImg=viewModel.detailimg+","+viewModel.detailimgNew}else{enddetailImg=viewModel.detailimgNew}var neData={"storeId":viewModel.data().storeId,"isvId":viewModel.data().isvId,"name":viewModel.data().name,"commitTime":viewModel.data().commitTime,"certificationStatus":viewModel.data().certificationStatus,"approveComment":viewModel.data().approveComment,"approveOperator":viewModel.data().approveOperator,"verifyTime":viewModel.data().verifyTime,"logo":$(".img-responsiveLOGO").attr("src")||"","banner":$(".img-responsiveBANNER").attr("src")||"","brief":$(".shop_introduction").val(),"introduction":UE.getEditor(viewModel.myEditor).getContent(),"snapshot":enddetailImg,"onlineTime":$(".userAddInput .onlineTime").val(),"telephone":$(".userAddInput .telephone").val(),"email":$(".userAddInput .email").val(),"hotline":$(".userAddInput .tel_value").val(),"customerService":telArr,};if($(".img-responsiveLOGO").attr("src")==undefined||$(".img-responsiveLOGO").attr("src")==""||$(".img-responsiveLOGO").attr("src")=="/market/common/images/icon_bg.png"){dialogmin("请上传店铺 logo~");return false}if($(".shop_introduction").val()==undefined||$(".shop_introduction").val()==""){dialogmin("请填写商家简介~");return false}if($(".img-responsiveBANNER").attr("src")==undefined||$(".img-responsiveBANNER").attr("src")==""||$(".img-responsiveBANNER").attr("src")=="/market/common/images/banner_bg.png"){dialogmin("请上传店招图片~");return false}if(neData.introduction==undefined||neData.introduction==""){dialogmin("请填写店铺说明~");return false}if(enddetailImg==undefined||enddetailImg==""){dialogmin("请上传店铺配图~");return false}if(neData.onlineTime==undefined||neData.onlineTime==""){dialogmin("请填写客服在线时间~");return false}if(neData.email==undefined||neData.email==""){dialogmin("请填写客服邮箱~");return false}if(neData.hotline==undefined||neData.hotline==""){dialogmin("请填写联系电话~");return false}var re=/^([a-z0-9A-Z]+[-|_.]?)+[a-z0-9A-Z]@([a-z0-9A-Z]+(-[a-z0-9A-Z]+)?\.)+[a-zA-Z]{2,}$/;var nubmer=$(".email").val();if(!re.test(nubmer)){alert("请输入正确格式的邮件地址");nubmer="";return false}if(n=="look"){$.ajax({type:"post",dataType:"json",async:false,data:JSON.stringify(neData),headers:{"Accept":"application/json","Content-Type":"application/json"},url:$ctx+postData,success:function(data){if(data.status==1){dialogmin("店铺预览");var previewUrl="/market/store/preview/"+data.storeId;$(".section-alert-box iframe").attr("src",previewUrl);return false}else{dialogmin("数据展示错误，请稍后重试！");return false}},error:function(XMLHttpRequest,textStatus,errorThrown){dialogmin("调用服务报错!请稍后重试。");return false}});viewModel.alertBosShow()}if(n=="save"){$.ajax({type:"post",dataType:"json",async:false,data:JSON.stringify(neData),headers:{"Accept":"application/json","Content-Type":"application/json"},url:$ctx+saveUrl,success:function(data){if(data.status==1){$(".spinner,.big_bg").hide();dialogmin("保存成功");function openUrl(){window.router.setRoute(preUrl)}setTimeout(openUrl(),3000);return false}else{$(".spinner,.big_bg").hide();dialogmin(data.msg)}},error:function(XMLHttpRequest,textStatus,errorThrown){dialogmin("调用服务报错!请稍后重试。")}})}};viewModel.Ueditor=function(con){var tId="editor"+new Date().getTime();$(".editorMyprductR").attr("id",tId);viewModel.myEditor=tId;var ue=UE.getEditor(tId,{});ue.ready(function(){if(con){ue.setContent(con)}var html=ue.getContent();var txt=ue.getContentTxt()})};viewModel.UpdateLogo=function(){if(viewModel.data().logo==""||viewModel.data().logo==undefined){$(".img-responsiveLOGO").attr("src",$ctx+"/common/images/icon_bg.png")}var up=WebUploader.create({server:$ctx+"/file/upload/img",swf:$ctx+"/common/trd/uploader/swf/Uploader.swf?v="+Math.random(),pick:".up",accept:[{title:"Images",extensions:"jpg,png",mimeTypes:"image/jpg,image/jpeg,image/png"}],duplicate:true,auto:true,thumb:{width:200,height:150,quality:90,crop:true,type:"image/jpeg",compressSize:0}});up.on("error",function(type){if(type=="Q_TYPE_DENIED"){dialogmin("请上传图片格式文件")}else{if(type=="F_EXCEED_SIZE"){dialogmin("文件大小不能超过5M")}else{if(type=="Q_EXCEED_NUM_LIMIT"){dialogmin("文件个数不能超过10")}}}});up.on("uploadSuccess",function(file,res){if(res.fileName!="-1"){$(".img-responsiveLOGO").attr("src",res.fileName)}});up.on("uploadError",function(file){dialogmin("上传失败")});up.on("uploadFinished",function(file){setTimeout(function(){var widthImg=$(".shoplogo img").width();var heightImg=$(".shoplogo img").height();if(widthImg<=heightImg){$(".shoplogo img").addClass("ImgHeights");$(".shoplogo img").removeClass("ImgWidths")}else{$(".shoplogo img").addClass("ImgWidths");$(".shoplogo img").removeClass("ImgHeights")}$(".shoplogo img").css("visibility","visible")},500)
});up.on("fileQueued",function(file){if(file.size>1024*1024*5){dialogmin("文件大小不能超过5M");return false}})};viewModel.UpdateBanner=function(){if(viewModel.data().banner==""||viewModel.data().banner==undefined){$(".img-responsiveBANNER").attr("src",$ctx+"/common/images/banner_bg.png")}var downurl=$ctx+"/file/down/img";var ups=WebUploader.create({server:$ctx+"/file/upload/img",swf:$ctx+"/common/trd/uploader/swf/Uploader.swf?v="+Math.random(),pick:".ups",accept:[{title:"Images",extensions:"jpg,png,gif",mimeTypes:"image/jpg,image/jpeg,image/png"}],auto:true,duplicate:true,thumb:{width:860,height:280,quality:90,crop:false,type:"image/jpeg",compressSize:0}});ups.on("error",function(type){if(type=="Q_TYPE_DENIED"){dialogmin("请上传图片格式文件")}else{if(type=="F_EXCEED_SIZE"){dialogmin("文件大小不能超过5M")}else{if(type=="Q_EXCEED_NUM_LIMIT"){dialogmin("文件个数不能超过10")}}}});ups.on("uploadSuccess",function(file,res){if(res.fileName!="-1"){$(".img-responsiveBANNER").attr("src",res.fileName)}});ups.on("uploadError",function(file){dialogmin("上传失败")});ups.on("uploadFinished",function(file){setTimeout(function(){var boxWidth=$(".shop_banner").width();var areaNum=parseInt("280")/parseInt("860");var widthImg=$(".shop_banner img").width();var heightImg=$(".shop_banner img").height();var imgAreaNum=parseInt(heightImg/widthImg);var boxHeight=boxWidth*areaNum;$(".shop_banner").height(boxHeight);if(heightImg>boxHeight){$(".tooHeight").show()}else{$(".shop_banner").css({"line-height":boxHeight+"px"});$(".tooHeight").hide()}$(".shop_banner img").css("visibility","visible")},500)});ups.on("fileQueued",function(file){if(file.size>1024*1024*5){dialogmin("文件大小不能超过5M");return false}})};viewModel.ImagesUp=function(wrapId,filePickerId,filePickerId2,snapshot){var $wrap=$(wrapId),$queue=$('<ul class="filelist"></ul>').appendTo($wrap.find(".queueList")),$statusBar=$wrap.find(".statusBar"),$info=$statusBar.find(".info"),$upload=$wrap.find(".uploadBtn"),$placeHolder=$wrap.find(".placeholder"),$progress=$statusBar.find(".progress").hide(),fileCount=0,fileSize=0,ratio=window.devicePixelRatio||1,thumbnailWidth=110*ratio,thumbnailHeight=110*ratio,state="pedding",percentages={},supportTransition=(function(){var s=document.createElement("p").style,r="transition" in s||"WebkitTransition" in s||"MozTransition" in s||"msTransition" in s||"OTransition" in s;s=null;return r})(),uploader;if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器");throw new Error("WebUploader does not support the browser you are using.")}uploader=WebUploader.create({pick:{id:filePickerId,label:"点击选择图片"},dnd:".queueList",paste:document.body,accept:{title:"Images",extensions:"gif,jpg,jpeg,bmp,png",mimeTypes:"image/jpg,image/jpeg,image/png"},server:$ctx+"/file/upload/img",swf:$ctx+"/common/trd/uploader/swf/Uploader.swf?v="+Math.random(),disableGlobalDnd:true,chunked:true,threads:true,compress:false,thread:1,fileNumLimit:10,fileSizeLimit:50*1024*1024,fileSingleSizeLimit:5*1024*1024});uploader.addButton({id:filePickerId2,label:"继续添加"});function addFile(file){var $li=$('<li id="'+file.id+'">'+'<p class="title">'+file.name+"</p>"+'<p class="imgWrap" id="'+file.id+'"></p>'+'<p class="progress"><span></span></p>'+"</li>"),$btns=$('<div class="file-panel">'+'<span class="cancel">删除</span>'+'<span class="rotateRight">向右旋转</span>'+'<span class="rotateLeft">向左旋转</span></div>').appendTo($li),$prgress=$li.find("p.progress span"),$wrap=$li.find("p.imgWrap"),$info=$('<p class="error"></p>'),showError=function(code){switch(code){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}$info.text(text).appendTo($li)};if(file.getStatus()==="invalid"){showError(file.statusText)}else{$wrap.text("预览中");if(file.loaded){var img=$('<img src="'+file.filename+'" id="'+file.id+'">');$wrap.empty().append(img)}else{uploader.makeThumb(file,function(error,src){if(error){$wrap.text("不能预览");return}var img=$('<img src="'+src+'" >');$wrap.empty().append(img)},thumbnailWidth,thumbnailHeight)}percentages[file.id]=[file.size,0];file.rotation=0}file.on("statuschange",function(cur,prev){if(prev==="progress"){$prgress.hide().width(0)}else{if(prev==="queued"){$li.off("mouseenter mouseleave");$btns.remove()}}if(cur==="error"||cur==="invalid"){showError(file.statusText);percentages[file.id][1]=1}else{if(cur==="interrupt"){showError("interrupt")}else{if(cur==="queued"){percentages[file.id][1]=0}else{if(cur==="progress"){$info.remove();$prgress.css("display","block")}else{if(cur==="complete"){$li.append('<span class="success"></span>')}}}}}$li.removeClass("state-"+prev).addClass("state-"+cur)});$li.on("mouseenter",function(){$btns.stop().animate({height:30})});$li.on("mouseleave",function(){$btns.stop().animate({height:0})});$btns.on("click","span",function(){var index=$(this).index(),deg;switch(index){case 0:uploader.removeFile(file);return;case 1:file.rotation+=90;break;case 2:file.rotation-=90;break}if(supportTransition){deg="rotate("+file.rotation+"deg)";$wrap.css({"-webkit-transform":deg,"-mos-transform":deg,"-o-transform":deg,"transform":deg})
}else{$wrap.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((file.rotation/90)%4+4)%4)+")")}});$li.appendTo($queue)}function removeFile(file){var $li=$("#"+file.id);delete percentages[file.id];updateTotalProgress();$li.off().find(".file-panel").off().end().remove()}function updateTotalProgress(){var loaded=0,total=0,spans=$progress.children(),percent;$.each(percentages,function(k,v){total+=v[0];loaded+=v[0]*v[1]});percent=total?loaded/total:0;spans.eq(0).text(Math.round(percent*100)+"%");spans.eq(1).css("width",Math.round(percent*100)+"%");updateStatus()}function updateStatus(){var text="",stats;var fileCounts=fileCount-1;if(state==="ready"){text="选中"+fileCounts+"张图片"+"。"}else{if(state==="confirm"){stats=uploader.getStats();if(stats.uploadFailNum){text="已成功上传"+stats.successNum+"张照片至相册，"+stats.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{stats=uploader.getStats();text="共"+fileCounts+"张，已上传"+stats.successNum+"张";if(stats.uploadFailNum){text+="，失败"+stats.uploadFailNum+"张"}}}$info.html(text)}function setState(val){var file,stats;if(val===state){return}$upload.removeClass("state-"+state);$upload.addClass("state-"+val);state=val;switch(state){case"pedding":$placeHolder.removeClass("element-invisible");$queue.parent().removeClass("filled");$queue.hide();$statusBar.addClass("element-invisible");uploader.refresh();break;case"ready":$placeHolder.addClass("element-invisible");$(filePickerId2).removeClass("element-invisible");$queue.parent().addClass("filled");$queue.show();$statusBar.removeClass("element-invisible");uploader.refresh();break;case"uploading":$progress.show();$upload.text("上传完成");break;case"paused":$progress.show();$upload.text("继续上传");break;case"confirm":$progress.hide();stats=uploader.getStats();if(stats.successNum&&!stats.uploadFailNum){setState("finish");return}break;case"finish":stats=uploader.getStats();if(stats.successNum){}else{state="done";location.reload()}break}updateStatus()}uploader.on("ready",function(){window.uploader=uploader;var json=snapshot;if(json==""||json==null){return}var arrayj=json.snapshot.split(",");var jsonLen=arrayj.length;if(jsonLen!=0){fileCount=jsonLen;$placeHolder.addClass("element-invisible");$statusBar.show();$.each(arrayj,function(i,n){if(arrayj[i]!=""){fileSize+=n.filelen;var obj={},statusMap={},file_id="WU_FILE_h"+i;obj.id=file_id;obj.name="";obj.filename=n;obj.getStatus=function(){return""};obj.setStatus=function(){return""};obj.statusText="";obj.size=100;obj.version=WebUploader.Base.version;obj.type="image/"+n.split(".")[1];obj.filetype=n.split(".")[1];obj.source=this;obj.loaded=true;obj.on=function(status,text){var prevStatus=statusMap[this.id];typeof text!=="undefined"&&(this.statusText=text);if(status!==prevStatus){statusMap[this.id]=status;uploader.trigger("statuschange",status,prevStatus)}};addFile(obj)}});WebUploader.Base.idSuffix=jsonLen;setState("ready");updateTotalProgress()}});uploader.onUploadProgress=function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress span");$percent.css("width",percentage*100+"%");percentages[file.id][1]=percentage;updateTotalProgress()};uploader.onFileQueued=function(file){fileCount++;fileSize+=file.size;if(fileCount===1){$placeHolder.addClass("element-invisible");$statusBar.show()}addFile(file);setState("ready");updateTotalProgress()};uploader.onFileDequeued=function(file){fileCount--;fileSize-=file.size;if(!fileCount){setState("pedding")}removeFile(file);updateTotalProgress()};uploader.on("all",function(type){var stats;switch(type){case"uploadFinished":setState("confirm");break;case"startUpload":setState("uploading");break;case"stopUpload":setState("paused");break}});uploader.on("error",function(type){if(type=="Q_TYPE_DENIED"){dialogmin("请上传图片格式文件")}else{if(type=="F_EXCEED_SIZE"){dialogmin("文件大小不能超过5M")}else{if(type=="Q_EXCEED_NUM_LIMIT"){dialogmin("文件个数不能超过10")}else{if(type=="F_DUPLICATE"){dialogmin("请不要重复上传")}}}}});uploader.on("uploadSuccess",function(file,res){var downurl=$ctx+"/file/down/img";if(res.fileName!="-1"){if(viewModel.detailimgNew!=""||viewModel.detailimgNew!=undefined){viewModel.detailimgNew+=","+res.fileName}else{viewModel.detailimgNew+=res.fileName}}});$upload.on("click",function(){if($(this).hasClass("disabled")){return false}if(state==="ready"){uploader.upload()}else{if(state==="paused"){uploader.upload()}else{if(state==="uploading"){uploader.stop()}}}});$info.on("click",".retry",function(){uploader.retry()});$info.on("click",".ignore",function(){alert("todo")});$upload.addClass("state-"+state);updateTotalProgress()};var init=function(parm){viewModel.load();viewModel.UpdateLogo();viewModel.UpdateBanner()};return{"model":viewModel,"template":template,"init":init}});